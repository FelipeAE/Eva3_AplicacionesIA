<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test APIs - Chatbot RRHH</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { margin: 5px; padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Test APIs - Chatbot RRHH</h1>
        
        <div class="section">
            <h2>🔐 Estado de Autenticación</h2>
            <button onclick="checkAuth()">Verificar Login</button>
            <div id="authStatus" class="result"></div>
            <p><strong>Nota:</strong> Necesitas estar logueado en <a href="http://localhost:8000" target="_blank">http://localhost:8000</a> para usar las APIs.</p>
        </div>

        <div class="section">
            <h2>📋 Sesiones de Chat</h2>
            <button onclick="listSessions()">📂 Listar Sesiones</button>
            <button onclick="createSession()">➕ Crear Nueva Sesión</button>
            <div id="sessionsResult" class="result"></div>
            
            <h3>📄 Ver Sesión Específica</h3>
            <input type="number" id="sessionId" placeholder="ID de sesión" value="1">
            <button onclick="getSession()">Ver Sesión</button>
            <div id="sessionResult" class="result"></div>
        </div>

        <div class="section">
            <h2>💬 Enviar Mensaje</h2>
            <input type="number" id="messageSessionId" placeholder="ID de sesión" value="1">
            <textarea id="messageContent" placeholder="Escribe tu mensaje..." rows="3">Dame el top 5 de honorarios</textarea>
            <button onclick="sendMessage()">📤 Enviar Mensaje</button>
            <div id="messageResult" class="result"></div>
        </div>

        <div class="section">
            <h2>🔧 Admin - Contextos (Solo Staff)</h2>
            <button onclick="listContexts()">📋 Listar Contextos</button>
            <div id="contextsResult" class="result"></div>
            
            <h3>➕ Crear Contexto</h3>
            <input type="text" id="contextName" placeholder="Nombre del contexto" value="Contexto de Prueba">
            <textarea id="contextPrompt" placeholder="Prompt del contexto..." rows="2">Responde de manera muy entusiasta</textarea>
            <button onclick="createContext()">Crear Contexto</button>
            <div id="createContextResult" class="result"></div>
        </div>

        <div class="section">
            <h2>⚙️ Términos Excluidos</h2>
            <button onclick="listExcludedTerms()">📋 Ver Términos Excluidos</button>
            <div id="termsResult" class="result"></div>
            
            <h3>➕ Agregar Término</h3>
            <input type="text" id="newTerm" placeholder="Nuevo término a excluir" value="test">
            <button onclick="addTerm()">Agregar</button>
            <div id="addTermResult" class="result"></div>
        </div>
    </div>

    <script>
        // Función para obtener el token CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Helper para hacer requests
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                credentials: 'include'
            };
            
            const response = await fetch(`http://localhost:8000/api/v1${url}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });
            
            const data = await response.json();
            return { response, data };
        }

        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }

        // Verificar autenticación
        async function checkAuth() {
            try {
                const { response, data } = await apiRequest('/sessions/');
                if (response.ok) {
                    showResult('authStatus', { status: 'Autenticado ✅', sessions_count: data.sessions?.length || 0 });
                } else {
                    showResult('authStatus', { status: 'No autenticado ❌', message: 'Necesitas hacer login en localhost:8000' }, true);
                }
            } catch (error) {
                showResult('authStatus', { error: error.message }, true);
            }
        }

        // Listar sesiones
        async function listSessions() {
            try {
                const { response, data } = await apiRequest('/sessions/');
                showResult('sessionsResult', data, !response.ok);
            } catch (error) {
                showResult('sessionsResult', { error: error.message }, true);
            }
        }

        // Crear sesión
        async function createSession() {
            try {
                const { response, data } = await apiRequest('/sessions/create/', { method: 'POST' });
                showResult('sessionsResult', data, !response.ok);
            } catch (error) {
                showResult('sessionsResult', { error: error.message }, true);
            }
        }

        // Ver sesión específica
        async function getSession() {
            const sessionId = document.getElementById('sessionId').value;
            if (!sessionId) {
                showResult('sessionResult', { error: 'Ingresa un ID de sesión' }, true);
                return;
            }
            
            try {
                const { response, data } = await apiRequest(`/sessions/${sessionId}/`);
                showResult('sessionResult', data, !response.ok);
            } catch (error) {
                showResult('sessionResult', { error: error.message }, true);
            }
        }

        // Enviar mensaje
        async function sendMessage() {
            const sessionId = document.getElementById('messageSessionId').value;
            const message = document.getElementById('messageContent').value;
            
            if (!sessionId || !message.trim()) {
                showResult('messageResult', { error: 'Ingresa ID de sesión y mensaje' }, true);
                return;
            }
            
            try {
                const { response, data } = await apiRequest(`/sessions/${sessionId}/message/`, {
                    method: 'POST',
                    body: JSON.stringify({ message: message.trim() })
                });
                showResult('messageResult', data, !response.ok);
            } catch (error) {
                showResult('messageResult', { error: error.message }, true);
            }
        }

        // Listar contextos (Admin)
        async function listContexts() {
            try {
                const { response, data } = await apiRequest('/admin/contexts/');
                showResult('contextsResult', data, !response.ok);
            } catch (error) {
                showResult('contextsResult', { error: error.message }, true);
            }
        }

        // Crear contexto (Admin)
        async function createContext() {
            const name = document.getElementById('contextName').value;
            const prompt = document.getElementById('contextPrompt').value;
            
            if (!name.trim() || !prompt.trim()) {
                showResult('createContextResult', { error: 'Ingresa nombre y prompt' }, true);
                return;
            }
            
            try {
                const { response, data } = await apiRequest('/admin/contexts/create/', {
                    method: 'POST',
                    body: JSON.stringify({ name: name.trim(), prompt: prompt.trim() })
                });
                showResult('createContextResult', data, !response.ok);
            } catch (error) {
                showResult('createContextResult', { error: error.message }, true);
            }
        }

        // Listar términos excluidos
        async function listExcludedTerms() {
            try {
                const { response, data } = await apiRequest('/settings/excluded-terms/');
                showResult('termsResult', data, !response.ok);
            } catch (error) {
                showResult('termsResult', { error: error.message }, true);
            }
        }

        // Agregar término excluido
        async function addTerm() {
            const term = document.getElementById('newTerm').value;
            
            if (!term.trim()) {
                showResult('addTermResult', { error: 'Ingresa un término' }, true);
                return;
            }
            
            try {
                const { response, data } = await apiRequest('/settings/excluded-terms/add/', {
                    method: 'POST',
                    body: JSON.stringify({ term: term.trim() })
                });
                showResult('addTermResult', data, !response.ok);
            } catch (error) {
                showResult('addTermResult', { error: error.message }, true);
            }
        }

        // Auto-check auth on page load
        window.addEventListener('load', checkAuth);
    </script>
</body>
</html>